# Build Fix Documentation - October 8, 2025

## Problem Summary
The project was failing to build with error: `npm run build exited with 1`. This occurred after deploying to Vercel and connecting Supabase, specifically after adding admin backend functionality.

## Root Causes Identified

### 1. **Corrupted node_modules** (Initial Issue)
- **Problem**: The `node_modules/next/dist/compiled/commander/package.json` file was corrupted
- **Symptom**: `SyntaxError: Error parsing package.json: Unexpected end of JSON input`
- **Fix**: Removed `node_modules` and `package-lock.json`, then ran fresh `npm install`

### 2. **TypeScript Module Resolution** 
- **Problem**: `moduleResolution: "node"` in `tsconfig.json` was incompatible with newer package exports
- **Symptom**: `Cannot find module '@t3-oss/env-nextjs'` despite the package being installed
- **Fix**: Changed `tsconfig.json` to use `moduleResolution: "bundler"`
  ```json
  "moduleResolution": "bundler"  // was "node"
  ```

### 3. **Incorrect Drizzle ORM API Usage**
- **Problem**: Admin dashboard was using incorrect Drizzle ORM syntax for count queries
- **Symptom**: `Property 'fn' does not exist on type 'PostgresJsDatabase'`
- **Original Code**:
  ```typescript
  db.select({ count: db.fn.count() }).from(db.schema.listings)
  ```
- **Fix**: Used `sql` helper and direct table imports
  ```typescript
  import { sql } from "drizzle-orm";
  import { listings } from "@/lib/db";
  
  db.select({ count: sql<number>`count(*)::int` }).from(listings)
  ```

### 4. **Environment Variable Type Safety**
- **Problem**: `SUPABASE_SERVICE_ROLE_KEY` was optional but used as required
- **Symptom**: `Type 'string | undefined' is not assignable to parameter of type 'string'`
- **Fix**: Made the environment variable required in `src/lib/env.ts`
  ```typescript
  SUPABASE_SERVICE_ROLE_KEY: z.string().min(1, "SUPABASE_SERVICE_ROLE_KEY is required for admin features")
  ```

### 5. **Static Generation of Dynamic Admin Pages** (Critical)
- **Problem**: Next.js was trying to statically generate admin pages that require database connections at build time
- **Symptom**: `Static page generation for /admin is still timing out after 3 attempts`
- **Root Cause**: Database connection during build time either:
  - Wasn't accessible from the build environment
  - Was hanging/timing out
  - Should never be called at build time for admin pages
- **Fix**: Added `export const dynamic = "force-dynamic"` to admin pages
  ```typescript
  // src/app/(admin)/admin/page.tsx
  export const dynamic = "force-dynamic";
  
  // src/app/(admin)/admin/listings/page.tsx
  export const dynamic = "force-dynamic";
  ```

## Files Modified

1. **tsconfig.json**
   - Changed `moduleResolution` from `"node"` to `"bundler"`

2. **src/lib/env.ts**
   - Made `SUPABASE_SERVICE_ROLE_KEY` required instead of optional

3. **src/app/(admin)/admin/page.tsx**
   - Fixed Drizzle ORM count queries
   - Added `export const dynamic = "force-dynamic"`
   - Imported tables directly instead of via `db.schema`

4. **src/app/(admin)/admin/listings/page.tsx**
   - Added `export const dynamic = "force-dynamic"`

5. **next.config.mjs**
   - (Previously had typed routes disabled in commit b70507f)

## Timeline of Issues

From git history, the problems started when:
1. **Initial working state**: Commit `0f22b9a` - "Initial commit: Complete CMS with Lagerlings-inspired design"
2. **Database integration**: Commit `fa9f3f3` - "Codex updates: restructure app with route groups, replace API/admin with new pages, add DB/env scaffolding"
3. **Admin backend**: Commit `971798d` - "fix: update drizzle config and db schema, add basic admin layout"
4. **Attempted fixes**: Multiple commits trying to fix typed routes and database queries
5. **Final fix**: Commit `16af0e8` - "fix: resolve build issues - update Drizzle queries, TypeScript config, and admin page rendering"

## Key Lessons Learned

1. **Admin pages should always be dynamic**: Never allow Next.js to statically generate pages that connect to databases
2. **TypeScript module resolution matters**: When using modern package exports, use `"bundler"` or `"node16"` module resolution
3. **Environment variables need proper typing**: Optional env vars can cause type errors when used as required
4. **Drizzle ORM version-specific APIs**: Version 0.28.6 uses `sql` helper for custom queries, not `db.fn`
5. **node_modules can corrupt**: Always safe to delete and reinstall when seeing mysterious package errors

## Deployment Checklist

Before deploying to Vercel, ensure:

- [ ] `npm run build` succeeds locally
- [ ] All admin routes have `export const dynamic = "force-dynamic"`
- [ ] Required environment variables are set in Vercel:
  - `NEXT_PUBLIC_SUPABASE_URL`
  - `NEXT_PUBLIC_SUPABASE_ANON_KEY`
  - `SUPABASE_SERVICE_ROLE_KEY`
  - `SUPABASE_DB_URL`
- [ ] Database is accessible from Vercel's deployment region
- [ ] TypeScript strict mode passes
- [ ] No build timeouts (pages complete within 60 seconds)

## Current Build Status

✅ **main branch**: Building successfully  
✅ **feature/admin-panel branch**: Building successfully  
⚠️ **Other branches**: May need the same fixes applied

## Next Steps

1. Test deployment to Vercel with the fixed code
2. Verify database connectivity in production
3. Monitor build logs for any timeouts
4. Consider adding authentication middleware to admin routes
5. Update documentation for new developers joining the project

